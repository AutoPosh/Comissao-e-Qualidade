<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!--------------------- BootStrap --------------------->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous"></script>

    <script src="https://kit.fontawesome.com/73cc2295d4.js" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="../static/operacao.css">
    <title>Operacional</title>

</head>

<body>

    <header>
        <nav>
            <img class="img-logo" src="../static/src/icons/logo_branca.png" draggable="false" onclick="logoClick()">
            <button type="button" class="logout btn btn-danger btn-md" onclick="logout()">Finalizar Sessão</button>
        </nav>
        <script>
            function logout() {
                fetch("/logout", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                })
                    .then(response => {
                        if (response.ok) {
                            console.log("Logou realizado com sucesso");
                            window.location.href = "/";
                        } else {
                            console.log("Erro ao realizar logout");
                        }
                    })
                    .catch(error => {
                        console.log("erro em logout", error);
                    });
            }
        </script>

    </header>
    <div class="container">
        <div class="container-itens container-inactive">
            <div class="janela-title">
                <h4> Olá, {{usuario}}</h3>
                    <h4> Seu ID é: {{id_user}}</h2>
            </div>
            <div class="itens">

                <label for="os">O.S.: </label>
                <input type="text" id="os" class="os">

                <label for="etapa">Etapa:</label>
                <input type="text" id="etapa" class="etapa">

                <label for="colab2">Colaborador 2</label>
                <select name="colab2" id="colab2" class="select">
                    <option value=""></option>
                    <option value="1">Joao</option>
                    <option value="2">italo</option>
                    <option value="3">Francisco</option>
                    <option value="4">Ramon</option>
                    <option value="5">Junior</option>
                </select>

                <label for="colab3">Colaborador 3</label>
                <select name="colab3" id="colab3" class="select">
                    <option value=""></option>
                    <option value="1">Joao</option>
                    <option value="2">italo</option>
                    <option value="3">Francisco</option>
                    <option value="4">Ramon</option>
                    <option value="5">Junior</option>
                </select>
            </div>
            <button class="btn btn-success btn-op" id="init-btn">Inicializar</button>
            <img class="active-bar rotate-inactive" src="../static/src/icons/prox.png" width=40px" draggable="false">
        </div>
    </div>

    <div class="container-tables">
        <div class="view-tables">
            <div class="div-os"><strong>OS</strong></div>
            <div class="div-etapa"><strong>Etapa</strong></div>
            <div class="div-servico"><strong>Serviço</strong></div>
            <div class="div-colabs"><strong>Colaborador</strong></div>
            <div class="div-status"><strong>Status</strong></div>
            <div class="container-controles"><strong>Controles</strong></div>
        </div>
        <div class="data-values">
            <div class="os-data">4980</div>
            <div class="etapa-data">235</div>
            <div class="servico-data">Servico da Etapa -> Descrição Resumida</div>
            <div class="colab-data">
                <div class="index1">Edneython</div>
                <div class="index2">Ana Gabriela</div>
                <div class="index3">Raiana</div>
            </div>
            <div class="status-servico">Inicializado</div>
            <div class="controles"><i class="fa-solid fa-arrow-rotate-left"
                    style="color: green; text-shadow: 0px 0px 2px rgba(0, 0, 0, 0.466); cursor: pointer;"></i>
                <i class="fa-regular fa-circle-pause"
                    style="color: red; text-shadow: 0px 0px 2px rgba(0, 0, 0, 0.466); cursor: pointer;"></i>
                <i class="fa-regular fa-circle-stop" style=" cursor: pointer;"></i>
            </div>
        </div>
    </div>


    <script>
        let operacional
        // Selecionando os elementos HTML
        const osInput = document.getElementById('os');
        const etapaInput = document.getElementById('etapa');
        const colab2Select = document.getElementById('colab2');
        const colab3Select = document.getElementById('colab3');


        osInput.addEventListener('input', function (event) {
            const value = event.target.value;
            event.target.value = value.replace(/\D/g, '');
        });

        etapaInput.addEventListener('input', function (event) {
            const value = event.target.value;
            event.target.value = value.replace(/\D/g, '');
        });


        // Event listener para o botão "Inicializar"
        document.getElementById("init-btn").addEventListener('click', () => {
            // Obtendo os valores dos inputs e selects
            const osValue = osInput.value;
            const etapaValue = etapaInput.value;
            const colab2Value = colab2Select.value;
            const colab3Value = colab3Select.value;
            let porc_colab1;
            let porc_colab2;
            let porc_colab3;


            // Verificando se algum valor é vazio
            if (osValue === "" || etapaValue === "") {
                alert("Preencha todos os campos antes de continuar");
                return; // Interrompe a execução do código
            }

            if (colab2Value === "" && colab3Value === "") {
                porc_colab1 = 1.00;
                porc_colab2 = 0.00;
                porc_colab3 = 0.00;

            } else if (colab2Value !== "" && colab3Value === "") {
                porc_colab1 = 0.50;
                porc_colab2 = 0.50;
                porc_colab3 = 0.00;
            } else if (colab2Value !== "" && colab3Value !== "") {
                porc_colab1 = (1.00 / 3.00).toFixed(2);
                porc_colab2 = (1.00 / 3.00).toFixed(2);
                porc_colab3 = (1.00 / 3.00).toFixed(2);
            }

            // Criando o objeto de dados a ser enviado para a API
            const dadosInicializar = {
                os: osValue,
                etapa: etapaValue,
                colab2: colab2Value,
                colab3: colab3Value,
                porc_colab1: porc_colab1,
                porc_colab2: porc_colab2,
                porc_colab3: porc_colab3
            };

            // Enviando a solicitação POST para a API
            fetch('/operacional/inicializar-servico', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dadosInicializar)
            })
                .then(response => response.json())
                .then(data => {

                    console.log('Dados: ', data.dados);
                    if (data.sucess) {
                        alert("Serviço Inicializado");

                        osInput.value = "";
                        etapaInput.value = "";
                    } else if(data.exists) {
                        alert('Dados já constam na base de dados')
                        console.log(data.dados)
                    }
                     else {
                        alert("Erro ao inicializar");
                        return; //Interrompe.
                    }

                })
                .catch(error => {
                    // Lidar com erros na solicitação
                    console.error('Erro:', error);
                });

        });


        function logoClick() {
            location.href = 'http://192.168.0.34:5000/homepage'
        }

        var containerItens = document.querySelector(".container-itens");
        var activeBar = document.querySelector(".active-bar");
        var startTouchX; // Posição inicial do toque
        var isDragging = false;

        activeBar.addEventListener("touchstart", function (event) {
            startTouchX = event.touches[0].clientX;
            isDragging = false;
        });

        activeBar.addEventListener("touchmove", function (event) {
            var currentTouchX = event.touches[0].clientX;
            var distance = currentTouchX - startTouchX;

            if (distance > 0 && !containerItens.classList.contains("container-active")) {
                isDragging = true;
            } else if (distance < 0 && containerItens.classList.contains("container-active")) {
                isDragging = true;
            }
        });

        activeBar.addEventListener("touchend", function (event) {
            if (isDragging) {
                var currentTouchX = event.changedTouches[0].clientX;
                var distance = currentTouchX - startTouchX;

                if (distance > 0 && !containerItens.classList.contains("container-active")) {
                    containerItens.classList.remove("container-inactive");
                    containerItens.classList.add("container-active");
                    activeBar.classList.remove("rotate-inactive");
                    activeBar.classList.add("rotate-active");
                } else if (distance < 0 && containerItens.classList.contains("container-active")) {
                    containerItens.classList.remove("container-active");
                    containerItens.classList.add("container-inactive");
                    activeBar.classList.remove("rotate-active");
                    activeBar.classList.add("rotate-inactive");
                }
            }
        });

        activeBar.addEventListener("click", function () {
            if (!isDragging) {
                if (containerItens.classList.contains("container-active")) {
                    containerItens.classList.remove("container-active");
                    containerItens.classList.add("container-inactive");
                    activeBar.classList.remove("rotate-active");
                    activeBar.classList.add("rotate-inactive");
                } else {
                    containerItens.classList.remove("container-inactive");
                    containerItens.classList.add("container-active");
                    activeBar.classList.remove("rotate-inactive");
                    activeBar.classList.add("rotate-active");
                }
            }
        });

        document.addEventListener("click", function (event) {
            var container = document.querySelector(".container-itens");
            var toggleIcon = document.querySelector(".active-bar");

            // Verifica se o clique ocorreu dentro da div .container-itens
            if (!container.contains(event.target)) {
                container.classList.remove("container-active");
                container.classList.add("container-inactive");
                toggleIcon.classList.remove("rotate-active");
                toggleIcon.classList.add("rotate-inactive");
            }
        });

        // Obtenha a referência para os elementos
        const statusServico = document.querySelector('.status-servico');
        const dataValues = document.querySelector('.data-values');

        // Verifique se o conteúdo da classe .status-servico é "Finalizado"
        if (statusServico.textContent === 'Finalizado') {
            // Altere a cor de fundo da classe .data-values para a cor de parada
            dataValues.style.backgroundColor = 'var(--stop-color)';
        } else if (statusServico.textContent === 'Inicializado') {
            dataValues.style.backgroundColor = 'var(--progress-color)'
        } else {
            dataValues.style.backgroundColor = 'var(--pause-color)'
        }

    </script>
</body>

</html>